{% extends "base.html" %}

{% block title %}Chat Room - Chat Application{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        height: calc(100vh - 200px);
        border: 2px solid var(--primary-color);
        position: relative;
        overflow: hidden;
    }
    
    .chat-container::before {
        content: '';
        position: absolute;
        top: -5px;
        left: -5px;
        right: -5px;
        bottom: -5px;
        border: 1px solid var(--accent-color);
        z-index: -1;
    }
    
    .sidebar {
        width: 250px;
        background-color: var(--primary-color);
        color: var(--light-text);
        padding: 15px;
        overflow-y: auto;
        border-right: 2px solid var(--accent-color);
    }
    
    .main-chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: var(--card-bg);
    }
    
    .messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: var(--background);
    }
    
    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 4px;
        max-width: 80%;
        word-wrap: break-word;
    }
    
    .message.sent {
        background-color: var(--accent-color);
        color: var(--light-text);
        margin-left: auto;
        border: 1px solid var(--danger-color);
    }
    
    .message.received {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        margin-right: auto;
    }
    
    .message .username {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    .message .timestamp {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 5px;
        display: block;
    }
    
    .message-form {
        padding: 15px;
        background-color: var(--card-bg);
        border-top: 1px solid var(--border-color);
        display: flex;
    }
    
    .message-input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-right: 10px;
        font-family: 'Courier New', monospace;
    }
    
    .message-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }
    
    .room-list {
        margin-top: 20px;
    }
    
    .room-item {
        padding: 10px;
        margin-bottom: 5px;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.3s;
    }
    
    .room-item:hover {
        background-color: var(--secondary-color);
    }
    
    .room-item.active {
        background-color: var(--accent-color);
        border: 1px solid var(--danger-color);
    }
    
    .room-title {
        font-size: 1.2rem;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--accent-color);
    }
    
    .user-list {
        margin-top: 20px;
    }
    
    .user-item {
        padding: 5px 0;
        display: flex;
        align-items: center;
    }
    
    .user-status {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 10px;
    }
    
    .user-status.online {
        background-color: var(--success-color);
    }
    
    .user-status.offline {
        background-color: var(--text-color);
    }
    
    .create-room-btn {
        width: 100%;
        margin-top: 15px;
    }
    
    .room-header {
        padding: 15px;
        background-color: var(--primary-color);
        color: var(--light-text);
        border-bottom: 1px solid var(--accent-color);
    }
    
    .room-header h3 {
        margin: 0;
    }
    
    .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }
    
    .connection-status .alert {
        margin-bottom: 0;
        padding: 10px 15px;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .connection-status i {
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="sidebar">
        <div class="room-title retro-text">[ CHAT ROOMS ]</div>
        <div class="room-list" id="room-list">
            <!-- Rooms will be populated here -->
        </div>
        <button class="btn btn-primary create-room-btn retro-text" id="create-room-btn">CREATE ROOM</button>
        
        <div class="user-list">
            <div class="room-title retro-text">[ ONLINE USERS ]</div>
            <div id="user-list">
                <!-- Users will be populated here -->
            </div>
        </div>
    </div>
    
    <div class="main-chat">
        <div class="room-header">
            <h3 id="current-room" class="retro-text">[ SELECT A ROOM ]</h3>
        </div>
        <div class="messages" id="messages">
            <!-- Messages will be populated here -->
        </div>
        <div class="message-form">
            <input type="text" class="message-input" id="message-input" placeholder="Type your message..." disabled>
            <button class="btn btn-primary retro-text" id="send-btn" disabled>SEND</button>
        </div>
    </div>
</div>

<!-- Passcode Modal -->
<div class="modal fade" id="passcodeModal" tabindex="-1" aria-labelledby="passcodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="passcodeModalLabel">Enter Room Passcode</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="passcodeInput" class="form-label">Passcode</label>
                    <input type="password" class="form-control" id="passcodeInput">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitPasscode">Join Room</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Room Modal -->
<div class="modal fade" id="createRoomModal" tabindex="-1" aria-labelledby="createRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createRoomModalLabel">Create New Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createRoomForm">
                    <div class="mb-3">
                        <label for="roomNameInput" class="form-label">Room Name</label>
                        <input type="text" class="form-control" id="roomNameInput" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Room</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="connection-status" id="connection-status" style="display: none;">
    <div class="alert alert-warning" role="alert">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="connection-message">Connecting...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000,
            transports: ['websocket', 'polling'],
            upgrade: true,
            rememberUpgrade: true,
            forceNew: true,
            forceNew: true
        });
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-btn');
        const roomList = document.getElementById('room-list');
        const userList = document.getElementById('user-list');
        const currentRoomDisplay = document.getElementById('current-room');
        const createRoomBtn = document.getElementById('create-room-btn');
        
        // Modal elements
        const passcodeModal = new bootstrap.Modal(document.getElementById('passcodeModal'));
        const createRoomModal = new bootstrap.Modal(document.getElementById('createRoomModal'));
        const passcodeInput = document.getElementById('passcodeInput');
        const submitPasscodeBtn = document.getElementById('submitPasscode');
        const roomNameInput = document.getElementById('roomNameInput');
        const roomPasscodeInput = document.getElementById('roomPasscodeInput');
        const submitCreateRoomBtn = document.getElementById('submitCreateRoom');
        const createRoomForm = document.getElementById('createRoomForm');
        
        let currentRoom = 'general';
        let pendingRoom = null;
        
        // Join default room on connection
        socket.emit('join', { room: 'general' });
        currentRoom = 'general';
        currentRoomDisplay.textContent = '[ GENERAL ]';
        messageInput.disabled = false;
        sendButton.disabled = false;
        
        // Handle room creation
        createRoomBtn.addEventListener('click', function() {
            createRoomModal.show();
        });
        
        function createRoom() {
            const roomName = roomNameInput.value.trim();
            if (roomName) {
                socket.emit('create_room', { room: roomName });
                roomNameInput.value = '';
                createRoomModal.hide();
            }
        }
        
        createRoomForm.addEventListener('submit', function(e) {
            e.preventDefault();
            createRoom();
        });
        
        // Handle sending messages
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && currentRoom) {
                socket.emit('message', { 
                    room: currentRoom, 
                    message: message,
                    username: '{{ current_user.username }}'
                });
                messageInput.value = '';
            }
        }
        
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Handle joining rooms
        function joinRoom(room) {
            if (currentRoom) {
                socket.emit('leave', { room: currentRoom });
            }
            socket.emit('join', { room: room });
            currentRoom = room;
            currentRoomDisplay.textContent = `[ ${room.toUpperCase()} ]`;
            messagesDiv.innerHTML = '';
            messageInput.disabled = false;
            sendButton.disabled = false;
            document.querySelectorAll('.room-list-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent.trim() === room) {
                    item.classList.add('active');
                }
            });
        }
        
        // Socket event handlers
        socket.on('message', function(data) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            
            if (data.username === '{{ current_user.username }}') {
                messageElement.classList.add('sent');
            } else {
                messageElement.classList.add('received');
            }
            
            const usernameSpan = document.createElement('div');
            usernameSpan.classList.add('username');
            usernameSpan.textContent = data.username;
            
            const messageText = document.createElement('div');
            messageText.classList.add('message-text');
            messageText.textContent = data.message;
            
            const timestamp = document.createElement('div');
            timestamp.classList.add('timestamp');
            timestamp.textContent = new Date().toLocaleTimeString();
            
            messageElement.appendChild(usernameSpan);
            messageElement.appendChild(messageText);
            messageElement.appendChild(timestamp);
            
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
        
        socket.on('room_list', function(data) {
            roomList.innerHTML = '';
            data.rooms.forEach(room => {
                const li = document.createElement('li');
                li.className = 'room-list-item';
                li.textContent = room.name;
                li.addEventListener('click', function() {
                    joinRoom(room.name);
                });
                roomList.appendChild(li);
            });
        });
        
        socket.on('user_list', function(data) {
            userList.innerHTML = '';
            data.users.forEach(function(user) {
                const userElement = document.createElement('div');
                userElement.classList.add('user-item');
                
                const statusElement = document.createElement('div');
                statusElement.classList.add('user-status');
                statusElement.classList.add(user.online ? 'online' : 'offline');
                
                const usernameElement = document.createElement('div');
                usernameElement.textContent = user.username;
                
                userElement.appendChild(statusElement);
                userElement.appendChild(usernameElement);
                userList.appendChild(userElement);
            });
        });
        
        // Request initial data
        socket.emit('get_rooms');
        socket.emit('get_users');

        const connectionStatus = document.getElementById('connection-status');
        const connectionMessage = document.getElementById('connection-message');

        // Connection status handlers
        socket.on('connect', function() {
            connectionStatus.style.display = 'none';
            console.log('Connected to server');
        });

        socket.on('disconnect', function() {
            connectionStatus.style.display = 'block';
            connectionMessage.textContent = 'Disconnected from server. Attempting to reconnect...';
            console.log('Disconnected from server');
        });

        socket.on('connect_error', function(error) {
            connectionStatus.style.display = 'block';
            connectionMessage.textContent = 'Connection error. Please check your internet connection.';
            console.error('Connection error:', error);
        });

        socket.on('reconnect', function(attemptNumber) {
            connectionStatus.style.display = 'none';
            console.log('Reconnected after ' + attemptNumber + ' attempts');
        });

        socket.on('reconnect_attempt', function(attemptNumber) {
            connectionMessage.textContent = 'Attempting to reconnect (attempt ' + attemptNumber + ')...';
            console.log('Reconnection attempt ' + attemptNumber);
        });

        socket.on('reconnect_error', function(error) {
            connectionMessage.textContent = 'Reconnection failed. Please refresh the page.';
            console.error('Reconnection error:', error);
        });

        socket.on('reconnect_failed', function() {
            connectionMessage.textContent = 'Failed to reconnect. Please refresh the page.';
            console.error('Failed to reconnect');
        });

        // Add WebSocket upgrade handler
        socket.on('upgrade', function() {
            console.log('Upgraded to WebSocket');
        });

        socket.on('upgrade_error', function(error) {
            console.error('WebSocket upgrade error:', error);
        });
    });
</script>
{% endblock %} 